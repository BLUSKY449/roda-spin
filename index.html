<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Undian Maju Presentasi</title>
  <style>
    :root{--bg:#0f172a;--fg:#e2e8f0;--card:#111827;--acc:#2563eb}
    *{box-sizing:border-box;font-family:Arial, Helvetica, sans-serif}
    body{margin:0;background:#0b1220;color:var(--fg);display:flex;min-height:100vh;align-items:center;justify-content:center;padding:16px}
    .app{width:100%;max-width:920px}
    .card{background:#111827;border:1px solid rgba(255,255,255,.07);border-radius:20px;box-shadow:0 10px 40px rgba(0,0,0,.5);padding:16px;position:relative}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    h1{margin:0 0 6px;font-size:22px;letter-spacing:.2px}
    p.sub{margin:0 0 8px;color:#94a3b8}
    .pointer{position:relative;width:min(92vw, 720px);margin-inline:auto}
    #wheel, #confetti {display:block;margin:auto}
    #confetti{position:absolute;left:50%;top:0;transform:translateX(-50%);pointer-events:none;z-index:5}
    .controls{display:grid;gap:10px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:1px solid rgba(255,255,255,.12);background:#0d1530;color:#e6edf7;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(90deg,#2563eb,#7c3aed);border:none}
    button.secondary{background:#1f2937;border:1px solid rgba(255,255,255,.18)}
    button.danger{background:#b91c1c;border:none}
    button:disabled{opacity:.6;cursor:not-allowed}
    .result{margin-top:8px;font-weight:700;font-size:18px}
    .winner-box{position:absolute;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10}
    .winner-content{background:#fff;color:#111;padding:24px 32px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.5);text-align:center;max-width:96%}
    .winner-content h2{margin:0 0 12px;font-size:24px;color:#2563eb}
    .winner-content p{font-size:28px;font-weight:bold;margin:0 0 16px}
    .winner-actions{display:flex;gap:10px;justify-content:center}
    .winner-content button{padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Undian Maju Presentasi</h1>
      <p class="sub">Tekan <b>PUTAR</b> untuk memilih salah satu.</p>
      <div class="grid">
        <div class="pointer">
          <canvas id="wheel" width="600" height="600"></canvas>
          <canvas id="confetti" width="600" height="600"></canvas>
        </div>
        <div class="controls">
          <div class="btns">
            <button class="primary" id="spinBtn">PUTAR</button>
            <button id="shuffleBtn">ACAK WARNA</button>
            <button id="resetBtn">RESET</button>
          </div>
          <div class="result" id="result">Siap diputarâ€¦</div>
        </div>
      </div>
      <div class="winner-box" id="winnerBox">
        <div class="winner-content">
          <h2>We have a winner!</h2>
          <p id="winnerName"></p>
          <div class="winner-actions">
            <button class="secondary" onclick="closeWinner()">Close</button>
            <button class="danger" onclick="removeWinner()">Remove</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resEl = document.getElementById('result');
    const winnerBox = document.getElementById('winnerBox');
    const winnerNameEl = document.getElementById('winnerName');

    const confetti = document.getElementById('confetti');
    const cctx = confetti.getContext('2d');

    // === Responsif & tajam di retina
    function fitCanvas(){
      const container = document.querySelector('.pointer');
      const maxSize = Math.min(container.clientWidth || 600, Math.floor(window.innerHeight * 0.75) || 600, 720);
      const size = Math.max(280, maxSize);
      const dpr = window.devicePixelRatio || 1;

      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      confetti.style.width = size + 'px';
      confetti.style.height = size + 'px';

      canvas.width  = Math.floor(size * dpr);
      canvas.height = Math.floor(size * dpr);
      confetti.width  = Math.floor(size * dpr);
      confetti.height = Math.floor(size * dpr);

      ctx.setTransform(1,0,0,1,0,0);
      cctx.setTransform(1,0,0,1,0,0);

      draw();
    }
    window.addEventListener('resize', fitCanvas);
    window.addEventListener('orientationchange', fitCanvas);

    // === Audio
    let audioCtx=null, unlocked=false;
    function ensureAudio(){ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended'){ audioCtx.resume(); } unlocked=true; }
    function playTick(){ if(!unlocked) return; const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(1400,audioCtx.currentTime); g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.001); g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.06); o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.065); }
    function playWin(){ if(!unlocked) return; const now=audioCtx.currentTime; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.6,now+0.02); g.gain.exponentialRampToValueAtTime(0.0001,now+1.2); g.connect(audioCtx.destination); [784,987,1175].forEach((f,i)=>{ const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(f,now); o.connect(g); o.start(now+i*0.02); o.stop(now+1.2); }); }

    // === Data roda
    let labels = ["Kelompok I","Kelompok II","Kelompok III"];
    let rotation = 0;
    let spinning = false;
    let colors = genColors();
    let lastTickIdx = -1;
    function genColors(){ const arr=[]; const n=3; const s=65, l=50; for(let i=0;i<n;i++){ const h=Math.round((i*360)/n); arr.push(`hsl(${h}, ${s}%, ${l}%)`);} return arr; }
    function shuffleColors(){ colors=colors.sort(()=>Math.random()-0.5); draw(); }

    // === Gambar roda
    function draw(){
      const width=canvas.width, height=canvas.height;
      const cx=width/2, cy=height/2;
      const r=Math.min(cx,cy)-20;
      ctx.clearRect(0,0,width,height);

      const n=labels.length, slice=(Math.PI*2)/n;
      ctx.save();
      ctx.translate(cx,cy);

      // Presisi: acuan atas (-90Â°) -> sektor rapi relatif ke panah
      const baseOffset = -Math.PI/2;
      ctx.rotate(rotation + baseOffset);

      ctx.lineWidth=2;
      for(let i=0;i<n;i++){
        const a0=i*slice, a1=a0+slice;

        // sektor
        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,a0,a1); ctx.closePath();
        ctx.fillStyle=colors[i%colors.length]; ctx.fill();
        ctx.strokeStyle='#fff'; ctx.stroke();

        // label: horizontal, responsif, di tengah sektor
        const mid=a0+slice/2;
        ctx.save();
        ctx.textBaseline='middle';
        let fontSize=Math.max(14, Math.floor(width*0.06));
        ctx.font=`bold ${fontSize}px Arial, Helvetica, sans-serif`;
        ctx.fillStyle='#0b0f1a';
        ctx.textAlign='center';
        const textRadius=r*0.70;
        const text=labels[i] || `Bagian ${i+1}`;
        while(ctx.measureText(text).width > r*1.2 && fontSize>12){
          fontSize -= 1;
          ctx.font=`bold ${fontSize}px Arial, Helvetica, sans-serif`;
        }
        // posisi titik teks persis di tengah sektor
        ctx.fillText(text, Math.cos(mid)*textRadius, Math.sin(mid)*textRadius);
        ctx.restore();
      }
      ctx.restore();

      // hub tengah (skala dinamis)
      const hubR=Math.max(18, Math.floor(width*0.055));
      ctx.beginPath(); ctx.arc(cx,cy,hubR,0,Math.PI*2);
      ctx.fillStyle='#0b1220'; ctx.fill();
      ctx.strokeStyle='#fff'; ctx.lineWidth=Math.max(2, Math.floor(width*0.006)); ctx.stroke();

      // panah besar di atas (dibesarkan)
      const pW=width*0.28, pH=height*0.30;
      ctx.beginPath();
      ctx.moveTo(cx, cy - r - 10);
      ctx.lineTo(cx - pW/2, cy - r - 10 - pH);
      ctx.lineTo(cx + pW/2, cy - r - 10 - pH);
      ctx.closePath();
      ctx.fillStyle='#ffffff';
      ctx.fill();
    }

    // === Hitung index pemenang (kompensasi baseOffset)
    function currentIndex(){
      const n=labels.length; const slice=(Math.PI*2)/n;
      let a=((Math.PI*2 - (rotation % (Math.PI*2))) + Math.PI*2) % (Math.PI*2);
      a=(a + (Math.PI/2)) % (Math.PI*2); // kompensasi -90Â° saat gambar
      return Math.floor(a / slice) % n;
    }

    function spin(){
      ensureAudio();
      if(spinning || labels.length < 2) return;
      spinning = true; resEl.textContent='Memutarâ€¦';
      spinBtn.disabled = shuffleBtn.disabled = resetBtn.disabled = true;
      lastTickIdx = currentIndex();

      const startRot=rotation;
      const target=startRot+(6+Math.floor(Math.random()*4))*Math.PI*2+Math.random()*Math.PI*2;
      const dur=4000; const t0=performance.now();

      function frame(t){
        const p=Math.min(1,(t-t0)/dur);
        const eased=1-Math.pow(1-p,3);
        rotation=startRot+(target-startRot)*eased;
        draw();
        const idxNow=currentIndex();
        if(idxNow!==lastTickIdx){ playTick(); lastTickIdx=idxNow; }
        if(p<1){ requestAnimationFrame(frame); }
        else{
          spinning=false;
          const idx=currentIndex();
          const name=labels[idx];
          resEl.textContent='Hasil: '+name+' ðŸŽ‰';
          spinBtn.disabled = shuffleBtn.disabled = resetBtn.disabled = false;
          playWin(); showWinner(name, idx); startConfetti();
        }
      }
      requestAnimationFrame(frame);
    }

    function reset(){ labels=["Kelompok I","Kelompok II","Kelompok III"]; rotation=0; colors=genColors(); draw(); resEl.textContent='Siap diputarâ€¦'; }

    // === Confetti
    let lastWinnerIndex=-1; let confettiParts=[]; let confettiRAF=null; let confettiEndAt=0;
    function startConfetti(){
      const N=200; confettiParts=[];
      for(let i=0;i<N;i++){
        confettiParts.push({x:canvas.width/2+(Math.random()-0.5)*80,y:40+Math.random()*40,vx:(Math.random()-0.5)*6,vy:2+Math.random()*4,sz:6+Math.random()*6,rot:Math.random()*Math.PI,vr:(Math.random()-0.5)*0.3,color:`hsl(${Math.floor(Math.random()*360)} 80% 60%)`,life:2.2+Math.random()*0.8});
      }
      confettiEndAt=performance.now()+2500; if(confettiRAF) cancelAnimationFrame(confettiRAF); loopConfetti();
    }
    function loopConfetti(){
      const now=performance.now();
      cctx.clearRect(0,0,confetti.width,confetti.height);
      for(const p of confettiParts){
        p.x+=p.vx; p.y+=p.vy; p.vy+=0.08; p.rot+=p.vr; p.life-=1/60;
        cctx.save(); cctx.translate(p.x,p.y); cctx.rotate(p.rot);
        cctx.fillStyle=p.color; cctx.fillRect(-p.sz/2,-p.sz/2,p.sz,p.sz*0.6); cctx.restore();
      }
      confettiParts=confettiParts.filter(p=>p.y<confetti.height+20 && p.life>0);
      if(now<confettiEndAt||confettiParts.length){ confettiRAF=requestAnimationFrame(loopConfetti); }
      else { cctx.clearRect(0,0,confetti.width,confetti.height); confettiRAF=null; }
    }

    function showWinner(name, idx){ lastWinnerIndex=idx; winnerNameEl.textContent=name; winnerBox.style.display='flex'; }
    function closeWinner(){ winnerBox.style.display='none'; cctx.clearRect(0,0,confetti.width,confetti.height); if(confettiRAF){ cancelAnimationFrame(confettiRAF); confettiRAF=null; } }
    function removeWinner(){ if(lastWinnerIndex>=0){ labels.splice(lastWinnerIndex,1); rotation=0; draw(); closeWinner(); resEl.textContent = labels.length>1 ? 'Pemenang dihapus. Siap putar lagiâ€¦' : 'Tinggal 1 item.'; } }

    // init
    fitCanvas();
    spinBtn.addEventListener('click', spin);
    shuffleBtn.addEventListener('click', shuffleColors);
    resetBtn.addEventListener('click', reset);
  </script>
</body>
</html>
